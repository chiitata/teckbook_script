== GitとGitHubの準備

アプリケーションが完成に近づいてきました。この章では、作成したアプリケーションをインターネット上に公開し、誰もがアクセスできるようにする「デプロイ」作業を行います。デプロイには、ソースコードを管理するためのGitと、それをホスティングするGitHubを利用します。

=== Gitによるバージョン管理の開始

Gitは、ファイルの変更履歴を記録・追跡するための「バージョン管理システム」です。`create-next-app`でプロジェクトを作成した際、すでにGitリポジトリは初期化されています。

まずは、これまでの作業内容をGitの履歴に記録（コミット）しましょう。Next.jsアプリケーションのルートディレクトリ（`my-youtube-app`）で、以下のコマンドを実行します。

```sh
# 変更されたファイルを全てステージングエリアに追加
$ git add .

# 変更内容をコミット
$ git commit -m "feat: Implement favorite feature"
```

`git add .`で、プロジェクト内の全ての変更（新規作成、修正、削除）を「コミット対象」としてステージングします。

`git commit -m "..."`で、ステージングされた変更内容に対して`"..."`というメッセージを付けて、ローカルリポジトリに記録します。コミットメッセージは、どのような変更を行ったのかが後から見て分かるように、簡潔に記述するのが一般的です。

=== GitHubリポジトリの作成

次に、ローカルリポジトリのソースコードを保管し、共有するためのリモートリポジトリをGitHub上に作成します。

 1. [GitHub](https://github.com/)にアクセスし、ログインします。（アカウントがない場合は作成してください）
 2. 右上の「+」アイコンから「New repository」を選択します。
 3. 「Repository name」に、ローカルのプロジェクト名と同じ `my-youtube-app` を入力します。
 4. 「Public」（公開）または「Private」（非公開）を選択します。ポートフォリオとして公開したい場合はPublicが良いでしょう。
 5. 「Create repository」ボタンをクリックします。

#image[github-new-repo][GitHubの新規リポジトリ作成画面]{
#}

=== ローカルリポジトリとリモートリポジトリの連携

リポジトリが作成されると、「…or push an existing repository from the command line」というセクションに、連携用のコマンドが表示されます。このコマンドをコピーして、ターミナルで実行します。

```sh
# リモートリポジトリのURLを`origin`という名前で登録
$ git remote add origin https://github.com/<あなたのユーザー名>/my-youtube-app.git

# 現在のブランチ名を`main`に変更
$ git branch -M main

# ローカルの`main`ブランチの内容を、リモートの`origin`にプッシュ（アップロード）
$ git push -u origin main
```

`git push`コマンドを実行すると、ローカルリポジトリに記録したソースコードがGitHubにアップロードされます。GitHubのページをリロードして、ファイルが表示されていれば成功です。

これで、ソースコードをデプロイする準備が整いました。次のセクションでは、いよいよVercelというホスティングサービスとこのGitHubリポジトリを連携させて、アプリケーションをデプロイします。
== Vercelへのデプロイ

GitHubにソースコードをプッシュできたら、いよいよデプロイです。本書では、Next.jsの開発元であるVercel社が提供するホスティングプラットフォーム「Vercel」を利用します。VercelはNext.jsに最適化されており、GitHubリポジトリと連携するだけで、驚くほど簡単にデプロイが完了します。

=== Vercelへのサインアップ

まずはVercelの公式サイトにアクセスし、アカウントを登録します。

 * https://vercel.com/

GitHubアカウントでサインアップするのが最もスムーズです。「Continue with GitHub」を選択し、画面の指示に従ってGitHubアカウントとVercelを連携させてください。

=== プロジェクトのインポート

Vercelのダッシュボードにログインしたら、GitHubリポジトリからプロジェクトをインポートします。

 1. ダッシュボードで「Add New...」>「Project」を選択します。
 2. 「Import Git Repository」のセクションに、あなたのGitHubリポジトリの一覧が表示されます。先ほど作成した`my-youtube-app`リポジトリの右側にある「Import」ボタンをクリックします。
    （リポジトリが表示されない場合は、VercelにGitHubリポジトリへのアクセス権を付与する必要があります）

#image[vercel-import-project][Vercelのプロジェクトインポート画面]{
#}

=== プロジェクトの設定とデプロイ

プロジェクトをインポートすると、設定画面が表示されます。VercelはNext.jsプロジェクトであることを自動的に検出し、最適なビルド設定を自動で構成してくれます。そのため、ほとんど設定を変更する必要はありません。

ただし、アプリケーションが動作するために必要な**環境変数**は、ここで設定する必要があります。

 1. 「Environment Variables」のセクションを開きます。
 2. ローカルの`.env.local`ファイルに設定した3つの環境変数を、一つずつ登録します。
    * `NEXT_PUBLIC_SUPABASE_URL`
    * `NEXT_PUBLIC_SUPABASE_ANON_KEY`
    * `YOUTUBE_API_KEY`

    キー（名前）とバリュー（値）を正確に入力してください。これらの値は、SupabaseやGoogle Cloud Platformのダッシュボードから再度確認できます。

#image[vercel-env-vars][Vercelの環境変数設定画面]{
#}

 3. 全ての環境変数を設定したら、「Deploy」ボタンをクリックします。

デプロイが開始され、ビルドとデプロイの進捗状況がリアルタイムで表示されます。数分待つと、デプロイが完了します。

デプロイが成功すると、紙吹雪が舞うお祝いのアニメーションと共に、アプリケーションのスクリーンショットと公開URLが表示されます。「Visit」ボタンをクリックして、デプロイされたあなたのアプリケーションにアクセスしてみましょう。

ローカル環境で見ていたものと同じアプリケーションが、インターネット上のURLで表示されれば、デプロイは成功です。

Vercelの素晴らしい点は、これだけではありません。今後、GitHubリポジトリの`main`ブランチに新しいコミットをプッシュすると、Vercelはそれを自動的に検知し、アプリケーションを自動で再デプロイしてくれます。この仕組みをCI/CD（継続的インテグレーション/継続的デプロイメント）と呼びます。

次のセクションでは、デプロイ後の設定や動作確認について解説します。
== デプロイ後の必須設定

Vercelへのデプロイは完了しましたが、アプリケーションが本番環境で正しく機能するためには、SupabaseとGoogle Cloud Platform側でいくつかの重要な設定を変更する必要があります。

=== Supabase Auth設定の更新

現在のSupabaseプロジェクトは、ユーザーがサインアップした後の確認メールなどに記載されるURLが、ローカル開発用の`http://localhost:3000`になっています。これを、Vercelによって割り当てられた本番URLに変更する必要があります。

 1. Supabaseのプロジェクトダッシュボードにアクセスします。
 2. 左側メニューから「Authentication」>「URL Configuration」を選択します。
 3. 「Site URL」の項目に、VercelでデプロイされたアプリケーションのURL（例: `https://my-youtube-app-xxxx.vercel.app`）を入力します。
 4. 「Save」ボタンをクリックして保存します。

#image[supabase-url-config][SupabaseのURL設定画面]{
#}

この設定により、Supabaseが送信するメール（パスワードリセット、メールアドレス確認など）に含まれるリンクが、本番環境の正しいURLを指すようになります。

=== YouTube APIキーの制限設定の更新

同様に、YouTube APIキーも、現在は`http://localhost:3000`からのリクエストしか許可していません。本番URLからのリクエストを許可するように設定を追加します。

 1. [Google Cloud Platformコンソール](https://console.cloud.google.com/)にアクセスします。
 2. 「APIとサービス」>「認証情報」ページに移動し、使用しているAPIキーを選択します。
 3. 「キーを制限」セクションの「ウェブサイトの制限」で「追加」をクリックします。
 4. VercelのURLにワイルドカードを追加した形式（例: `https://my-youtube-app-xxxx.vercel.app/*`）を入力します。
 5. 「保存」をクリックします。

#image[gcp-api-key-prod][本番URLを追加したAPIキーの制限設定]{
#}

これで、ローカル環境と本番環境の両方から安全にAPIを呼び出すことができるようになりました。

=== カスタムドメイン（補足）

Vercelでは、`*.vercel.app`というドメインだけでなく、独自に取得したドメイン（例: `my-youtube-app.com`）をアプリケーションに設定することも非常に簡単です。

Vercelのプロジェクトダッシュボードから「Settings」>「Domains」と進み、所有しているドメイン名を追加し、画面の指示に従ってDNS設定を行うことで、よりプロフェッショナルなURLでアプリケーションを公開できます。興味がある方はぜひ試してみてください。

これらの設定を終えて、初めてデプロイ作業が完了したと言えます。次のセクションでは、公開されたアプリケーションの最終的な動作確認を行います。
== 動作確認とトラブルシューティング

全てのデプロイ作業と設定が完了しました。最後に、公開されたアプリケーションが意図した通りに動作するかを、ユーザーの視点で一通り確認しましょう。また、問題が発生した場合の基本的な調査方法についても解説します。

=== 動作確認リスト

本番URL（`https://...vercel.app`）にアクセスし、以下の項目をチェックしてみてください。

 * **[ ] トップページの表示**: 検索フォームが正しく表示されるか。
 * **[ ] 新規ユーザー登録**: 新しいメールアドレスとパスワードでサインアップできるか。Supabaseから確認メールが届くか。
 * **[ ] ログイン・ログアウト**: 登録したユーザーでログインできるか。ログイン後、ヘッダーの表示が「マイページ」「ログアウト」に切り替わるか。ログアウトできるか。
 * **[ ] 動画検索**: キーワードを入力して動画を検索できるか。検索結果が正しく表示されるか。
 * **[ ] お気に入り機能**: ログイン状態で、動画をお気に入り登録・解除できるか。（※この機能はUIを完全に実装していないため、エラーが出ないことを確認）
 * **[ ] マイページ**: マイページにアクセスできるか。お気に入りに登録した動画が表示されるか。
 * **[ ] 認証制御**: ログアウト状態でマイページ（`/mypage`）にアクセスしようとした際に、ログインページ（`/login`）にリダイレクトされるか。

これらの機能が全て正常に動作していれば、アプリケーションは無事に完成です！

=== トラブルシューティング

もし期待通りに動作しない場合は、Vercelのログを確認するのが問題解決の第一歩です。

**Vercelのログ確認方法:**

 1. Vercelのプロジェクトダッシュボードにアクセスします。
 2. 上部のタブから「Logs」を選択します。

ここには、ビルド時のログや、アプリケーションがリクエストを受け取った際のサーバーサイドのログ（`console.log`など）が表示されます。Server ComponentsやServer Actions内で発生したエラーは、主にここで確認できます。

#image[vercel-logs][Vercelのログ画面]{
#}

**よくある問題とチェックポイント:**

 * **500 Internal Server Errorが表示される**: 
   * Vercelのログを確認し、エラーメッセージを読み解きましょう。
   * Server ComponentsやServer Actions内で、環境変数が正しく読み込めていない可能性があります。Vercelの環境変数設定を再確認してください。

 * **Supabaseの操作でエラーが出る**: 
   * VercelのログにSupabaseからのエラーメッセージが出力されていないか確認します。
   * RLSポリシーが正しく設定されているか、Supabaseのダッシュボードで再確認してください。

 * **認証がうまくいかない**: 
   * SupabaseのAuth設定（URL Configurationなど）が本番URLになっているか確認してください。

 * **クライアントサイドのエラー**: 
   * ブラウザの開発者ツール（F12キーなどで開く）の「Console」タブにエラーメッセージが表示されていないか確認します。

エラーの原因を特定し、コードを修正してGitHubにプッシュすれば、Vercelが自動で再デプロイを行ってくれます。粘り強く問題解決に取り組むことも、エンジニアにとって重要なスキルの一つです。

これで第7章は完了です。お疲れ様でした。次の最終章では、このアプリケーションをさらに良くするためのステップアップ案をいくつか紹介します。
