== Next.jsの最適化

Next.jsはデフォルトでも高いパフォーマンスを発揮しますが、その真価は豊富な最適化機能にあります。ここでは、アプリケーションのパフォーマンスをさらに向上させるためのいくつかの重要なトピックを紹介します。

=== 画像の最適化 (`next/image`)

Webサイトの表示速度に大きな影響を与える要素の一つが画像です。Next.jsには、画像を自動的に最適化してくれる`<Image>`コンポーネント（`next/image`）が組み込まれています。

現在、検索結果のサムネイル表示には通常の`<img>`タグを使用していますが、これを`<Image>`コンポーネントに置き換えることで、以下のようなメリットが得られます。

 * **自動的なフォーマット変換**: ブラウザが対応していれば、JPEGやPNGといった従来のフォーマットより軽量なWebPやAVIF形式で画像を配信します。
 * **リサイズの最適化**: デバイスの画面サイズに応じた、適切なサイズの画像を自動的に生成・配信します。これにより、不必要に大きな画像をダウンロードさせることを防ぎます。
 * **遅延読み込み（Lazy Loading）**: 画面に表示されていない画像（スクロールしないと見えない場所にある画像）の読み込みを、画面内に入るまで遅延させます。初期表示の高速化に大きく貢献します。

```tsx
# <Image>コンポーネントの使用例
import Image from 'next/image'

# ...

<Image
  src={fav.thumbnail_url} // 外部URLの場合、設定が必要
  alt={fav.video_title}
  width={320} // 表示する幅
  height={180} // 表示する高さ
  className="w-full rounded-md mb-2"
/>
```

NOTE: 外部ドメインの画像（今回のようにYouTubeのサムネイルなど）を`<Image>`コンポーネントで利用するには、`next.config.js`ファイルにドメインを登録する必要があります。

=== キャッシュ戦略

Next.jsのApp Routerは、非常に強力なキャッシュ機構を備えています。Server Componentsが`fetch`を使って取得したデータは、デフォルトで永続的にキャッシュされます。これにより、ビルド時に取得したデータを、リクエストのたびに再取得することなく高速に表示できます。

しかし、今回のように検索機能など、常に最新のデータを表示したい場合もあります。`fetch`のオプションを調整することで、キャッシュの挙動を細かく制御できます。

```javascript
# キャッシュを無効にする例
fetch('https://...', { cache: 'no-store' })

# 一定時間（例: 60秒）だけキャッシュする例 (ISR: Incremental Static Regeneration)
fetch('https://...', { next: { revalidate: 60 } })
```

Supabaseのクライアントライブラリは内部で`fetch`を使用しているため、これらのキャッシュ戦略と組み合わせて利用することも可能です。（詳細は公式ドキュメントを参照してください）

ページの特性（更新頻度など）に応じて適切なキャッシュ戦略を選択することが、パフォーマンスとデータの鮮度を両立させる鍵となります。

=== 動的レンダリングと静的レンダリング

App Routerでは、ページが動的レンダリングされるか、静的レンダリング（SSG: Static Site Generation）されるかが、コードの内容によって自動的に決まります。

 * **静的レンダリング**: ページ内で`cookies()`や`headers()`といった動的な関数や、キャッシュを無効にした`fetch`が使われていない場合、そのページはビルド時に静的なHTMLとして生成されます。CDNから配信できるため、非常に高速です。
 * **動的レンダリング**: 動的な関数が使われている場合、ページはリクエストごとにサーバーでレンダリングされます。

例えば、お気に入り一覧を表示するマイページは、`cookies()`を使ってユーザー認証を行っているため、動的レンダリングされます。一方で、企業の製品紹介ページのような、内容が頻繁に変わらないページは静的レンダリングの恩恵を最大限に受けることができます。

Next.jsのこれらの最適化機能を理解し、使いこなすことで、ユーザー体験を劇的に向上させることができます。ぜひ公式ドキュメントを片手に、さらなるパフォーマンスの追求に挑戦してみてください。
